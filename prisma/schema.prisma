generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum AuthProvider {
  EMAIL
  KAKAO
  NAVER
  GOOGLE
  APPLE
}

model User {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  email           String?       @unique  // 소셜 로그인 시 이메일이 제공되지 않을 수도 있음
  name            String
  gender          String?       // 소셜 로그인에서 제공되지 않을 수 있음
  age             Int?          // 소셜 로그인에서 제공되지 않을 수 있음
  hashed_password String?       // 소셜 로그인만 사용하는 경우 null 가능
  profile_image   String?
  bio             String?
  is_verified     Boolean       @default(false)
  created_at      DateTime      @default(now())
  updated_at      DateTime      @updatedAt
  
  // 소셜 로그인 정보
  social_connections SocialConnection[]
  
  // 인증 토큰
  auth_tokens     AuthToken[]
  
  // 관계
  created_courses DateCourse[]  @relation("CreatedCourses")
  saved_courses   SavedCourse[]
  reviews         Review[]
}

model SocialConnection {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  user_id         String        @db.ObjectId
  user            User          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  provider        AuthProvider
  provider_user_id String       // 외부 서비스에서의 사용자 ID
  provider_data   Json?         // 제공자로부터 받은 추가 데이터
  created_at      DateTime      @default(now())
  updated_at      DateTime      @updatedAt
  
  // @@unique([provider, provider_user_id])
  @@index([user_id])
}

model AuthToken {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  user_id         String        @db.ObjectId
  user            User          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  refresh_token   String        @unique
  access_token    String?       // 필요한 경우 access token도 저장 가능
  device_info     String?       // 기기 정보 (선택사항)
  ip_address      String?       // 로그인 IP (선택사항)
  expires_at      DateTime
  is_revoked      Boolean       @default(false)
  created_at      DateTime      @default(now())
  updated_at      DateTime      @updatedAt
  
  @@index([user_id, refresh_token])
}

model DateCourse {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  name            String
  description     String
  creator_id      String        @db.ObjectId
  creator         User          @relation("CreatedCourses", fields: [creator_id], references: [id])
  thumbnail       String
  tags            String[]
  price           Int           // 예상 비용
  total_time      Int?          // 총 소요시간(분)
  total_distance  Int?          // 총 이동거리(미터)
  is_public       Boolean       @default(true)
  view_count      Int           @default(0)
  like_count      Int           @default(0)
  rating          Float         @default(0)
  created_at      DateTime      @default(now())
  updated_at      DateTime      @updatedAt
  
  // 관계
  places          CoursePlaces[]
  saved_by        SavedCourse[]
  reviews         Review[]
}

model Place {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  name            String
  address         String
  road_address    String?
  latitude        Float
  longitude       Float
  category        String
  naver_place_id  String?       @unique
  naver_category  String?
  phone           String?
  homepage        String?
  business_hours  Json?
  description     String?
  thumbnail       String?
  naver_rating    Float?
  naver_review_count Int?       @default(0)
  created_at      DateTime      @default(now())
  updated_at      DateTime      @updatedAt
  
  // 관계
  course_places   CoursePlaces[]
}

model CoursePlaces {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  course_id       String        @db.ObjectId
  course          DateCourse    @relation(fields: [course_id], references: [id], onDelete: Cascade)
  place_id        String        @db.ObjectId
  place           Place         @relation(fields: [place_id], references: [id])
  visit_order     Int           // 방문 순서
  recommended_time Int?         // 추천 체류 시간(분)
  tips            String?       // 장소 이용 팁
  created_at      DateTime      @default(now())
  updated_at      DateTime      @updatedAt
  
  @@unique([course_id, visit_order])
}


model SavedCourse {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  user_id         String        @db.ObjectId
  user            User          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  course_id       String        @db.ObjectId
  course          DateCourse    @relation(fields: [course_id], references: [id], onDelete: Cascade)
  saved_at        DateTime      @default(now())
  
  @@unique([user_id, course_id])
}

model Review {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  course_id       String        @db.ObjectId
  course          DateCourse    @relation(fields: [course_id], references: [id], onDelete: Cascade)
  user_id         String        @db.ObjectId
  user            User          @relation(fields: [user_id], references: [id])
  rating          Int           // 1-5 평점
  comment         String?
  visited_date    DateTime?
  images          ReviewImage[]
  created_at      DateTime      @default(now())
  updated_at      DateTime      @updatedAt
  
  @@unique([user_id, course_id])
}

model ReviewImage {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  review_id       String        @db.ObjectId
  review          Review        @relation(fields: [review_id], references: [id], onDelete: Cascade)
  image_url       String
  created_at      DateTime      @default(now())
}